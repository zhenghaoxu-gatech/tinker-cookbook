name: Claude Code

permissions:
  contents: write        # allow Claude to edit files & push commits
  pull-requests: write   # allow PR comments/reviews & PR creation
  issues: write          # allow issue comments & labels

  id-token: write       # Necessary because otherwise we get:
    # Error: Failed to setup GitHub token: Error: Could not fetch an OIDC token. Did you remember to add `id-token: write` to your workflow permissions?
    # If you instead wish to use this action with a custom GitHub token or custom GitHub app, provide a `github_token` in the `uses` section of the app in your workflow yml file.
  actions: read
    # ^^^ Not sure if this is necessary, but my previous working configuration had it.

on:
  # 1) Automatic PR review (non‑excessive)
  pull_request:
    types: [opened, reopened, ready_for_review]

  # 2) Talk to @claude in PRs & issues
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]

env:
  # Shared Claude CLI configuration for all jobs
  CLAUDE_ARGS_COMMON: >
    --max-turns 50
    --allowedTools "Read" "Write" "Edit" "MultiEdit"
    "Glob" "Grep" "LS"
    "Bash(git:*)" "Bash(gh:*)"
    "mcp__github_inline_comment__create_inline_comment"

jobs:
  pr_review:
    name: Automatic PR review
    runs-on: ubuntu-latest
    # Only run this job for pull_request events
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Claude PR review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Official slash command for PR review (context comes from the PR event)
          # https://code.claude.com/docs/en/github-actions#using-slash-commands
          prompt: "/review"
          claude_args: ${{ env.CLAUDE_ARGS_COMMON }}
          track_progress: true
          show_full_output: true

  claude_mention:
    name: Respond to @claude in issues & PRs
    runs-on: ubuntu-latest
    # Only run when @claude actually appears
    if: >
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' &&
       contains(github.event.issue.body, '@claude'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Claude on @mention
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # No prompt → action switches to "tag" mode and responds to @claude
          # https://code.claude.com/docs/en/github-actions#configuration-examples
          claude_args: ${{ env.CLAUDE_ARGS_COMMON }}
